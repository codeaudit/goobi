/*!
 * This file is part of the Goobi viewer - a content presentation and management application for digitized objects.
 *
 * Visit these websites for more information.
 * - http://www.intranda.com
 * - http://digiverso.com
 *
 * This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free
 * Software Foundation; either version 2 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program. If not, see <http://www.gnu.org/licenses/>.
 */
var viewImage=function(){"use strict";function e(e,o){var t={};return t.viewerOpen=Rx.Observable.create(function(e){o.addOnceHandler("open",function(o){return o.osState="open",Number.isNaN(o.eventSource.viewport.getHomeBounds().x)?e.onError("Unknow error loading image from ",s.image.tileSource):e.onNext(o)}),o.addOnceHandler("open-failed",function(o){return o.osState="open-failed",console.log("Failed to open openseadragon "),e.onError(o)})}),t.firstTileLoaded=Rx.Observable.create(function(e){o.addOnceHandler("tile-loaded",function(o){return o.osState="tile-loaded",e.onNext(o)}),o.addOnceHandler("tile-load-failed",function(o){return o.osState="tile-load-failed",console.log("Failed to load tile"),e.onError(o)})}),t.viewerZoom=Rx.Observable.create(function(e){o.addHandler("zoom",function(o){return e.onNext(o)})}),t.viewportUpdate=Rx.Observable.create(function(e){o.addHandler("update-viewport",function(o){return e.onNext(o)})}),t.viewerRotate=Rx.Observable.create(function(e){o.addHandler("rotate",function(o){return o.osState="rotate",e.onNext(o)})}),t.canvasResize=Rx.Observable.create(function(e){o.addHandler("resize",function(o){return o.osState="resize",e.onNext(o)})}),t.windowResize=Rx.Observable.fromEvent(e,"resize").map(function(e){return e.osState="window resize",e}),t.overlayRemove=Rx.Observable.create(function(e){o.addHandler("remove-overlay",function(o){return e.onNext(o)})}),t.overlayUpdate=Rx.Observable.create(function(e){o.addHandler("update-overlay",function(o){return e.onNext(o)})}),t.levelUpdate=Rx.Observable.create(function(e){o.addHandler("update-level",function(o){return e.onNext(o)})}),t.redrawRequired=t.viewerOpen.merge(t.viewerRotate.merge(t.canvasResize).debounce(10)).map(function(e){var o={};return n.controls&&(o=n.controls.getLocation()),"open"===e.osState&&(o.zoom=n.viewer.viewport.getHomeZoom(),s.image.location&&(o=s.image.location)),e.targetLocation=o,e}).publish(),t}function o(e){a&&(console.log("viewImage: calcualte sizes"),console.log("Home zoom = ",e.viewer.viewport.getHomeZoom())),e.sizes=new viewImage.Measures(e),s.global.adaptContainerHeight&&e.sizes.resizeCanvas(),null!=e.viewer&&e.viewer.viewport.setMargins({bottom:e.sizes.footerHeight+e.sizes.calculateExcessHeight()}),a&&console.log("sizes: ",e.sizes)}function t(e){if(s.global.footerHeight>0){var o=s.global.footerHeight,t=new OpenSeadragon.Point(0,i.height()-o),a=new OpenSeadragon.Point(i.width(),o);r||(r=n.viewer.drawer.context.canvas.width/n.viewer.drawer.context.canvas.clientWidth),1!=r&&(t=t.times(r),a=a.times(r)),n.viewer.drawer.context.drawImage(l,t.x,t.y,a.x,a.y)}}var r,i,n={},a=!1,l=null,s={global:{divId:"map",zoomSlider:".zoom-slider",zoomSliderHandle:".zoom-slider-handle",overlayGroups:[{name:"searchHighlighting",styleClass:"searchHighlight",interactive:!1},{name:"ugc",styleClass:"ugcBox",interactive:!0}],zoomSpeed:1.25,maxZoomLevel:20,minZoomLevel:1,useTiles:!0,imageControlsActive:!0,visibilityRatio:.4,loadImageTimeout:6e5,maxParallelImageLoads:4,adaptContainerHeight:!1,footerHeight:50,rememberZoom:!1,rememberRotation:!1},image:{},getOverlayGroup:function(e){for(var o=s.global.overlayGroups,t=0;t<o.length;t++){var r=o[t];if(r.name===e)return r}},getCoordinates:function(e){var o=s.image.highlightCoords;if(o)for(var t=0;t<o.length;t++){var r=o[t];if(r.name===e)return r}}};return n={viewer:null,init:function(e){a&&(console.log("##############################"),console.log("osViewer.init"),console.log("##############################")),$.extend(!0,s,e),s.image.mimeType=s.image.mimeType.replace("jpeg","jpg"),i=$("#"+s.global.divId);var o=s.image.tileSource;"string"==typeof o&&o.startsWith("[")?o=JSON.parse(o):$.isArray(o)||(o=[o]);for(var t=[],r=0;r<o.length;r++){var n=o[r],l=viewImage.createTileSource(n);t.push(l)}return Q.all(t).then(function(e){for(var o=Number.MAX_VALUE,t=Number.MAX_VALUE,r=Number.MAX_VALUE,i=0;i<e.length;i++){s=e[i];o=Math.min(o,s.width),t=Math.min(t,s.height),r=Math.min(r,s.aspectRatio)}a&&console.log("Min aspect ratio = "+r);for(var n=0,l=0;l<e.length;l++){var s=e[l];e[l]={tileSource:s,width:s.aspectRatio/r,x:n,y:0},n+=e[l].width}return viewImage.loadImage(e)})},loadImage:function(o){a&&console.log("Loading image with tilesource: ",o),n.loadFooter(),n.viewer=new OpenSeadragon({immediateRender:!1,visibilityRatio:s.global.visibilityRatio,sequenceMode:!1,id:s.global.divId,controlsEnabled:!1,prefixUrl:"/openseadragon-bin/images/",zoomPerClick:1,maxZoomLevel:s.global.maxZoomLevel,minZoomLevel:s.global.minZoomLevel,zoomPerScroll:s.global.zoomSpeed,mouseNavEnabled:s.global.zoomSpeed>1,showNavigationControl:!1,showZoomControl:!1,showHomeControl:!1,showFullPageControl:!0,timeout:s.global.loadImageTimeout,tileSources:o,blendTime:.5,alwaysBlend:!1,imageLoaderLimit:s.global.maxParallelImageLoads,viewportMargins:{top:0,left:0,right:0,bottom:s.global.footerHeight}});var t=Q.defer();return n.observables=e(window,n.viewer),n.observables.viewerOpen.subscribe(function(e,o){t.resolve(n)},function(e){t.reject(e)}),n.observables.redrawRequired.subscribe(function(e){a&&console.log("viewer "+e.osState+"ed with target location ",e.targetLocation),n.redraw()}),n.controls&&n.controls.init(s),n.zoomSlider&&n.zoomSlider.init(s),n.overlays&&n.overlays.init(s),n.drawRect&&n.drawRect.init(),n.transformRect&&n.transformRect.init(),n.observables.redrawRequired.connect(),t.promise},getObservables:function(){return console.log("Observables = ",n.observables),n.observables},hasFooter:function(){return null!=l},getConfig:function(){return s},loadFooter:function(){s.image.baseFooterUrl&&s.global.footerHeight>0&&((l=new Image).src=s.image.baseFooterUrl.replace("{width}",Math.round(i.width())).replace("{height}",Math.round(s.global.footerHeight)),l.onload=function(){a&&(console.log("loading footer image ",l),console.log("Calculating image Footer size")),n.drawFooter()})},drawFooter:function(){n.viewer&&t(),n.viewer.removeHandler("update-viewport",t),n.viewer.addHandler("update-viewport",t)},getOverlayGroup:function(e){return s.getOverlayGroup(e)},getHighlightCoordinates:function(e){return s.getCoordinates(e)},createPyramid:function(e){var o=s.image.mimeType;o=o.replace("image/",""),o=o.replace("jpeg","jpg").replace("tiff","tif");var t,r=[];return Array.isArray(e)?(e.forEach(function(e){e.mimetype=s.image.mimeType}),t=new OpenSeadragon.LegacyTileSource(e)):e.sizes?(e.sizes.forEach(function(t){a&&(console.log("Image level width = ",t.width),console.log("Image level height = ",t.height));var i={mimetype:s.image.mimeType,url:e["@id"].replace("/info.json","")+"/full/"+t.width+",/0/default."+o,width:e.width,height:e.height};a&&console.log("Created level ",i),r.push(i)}),t=new OpenSeadragon.LegacyTileSource(r)):t=new OpenSeadragon.ImageTileSource({url:e["@id"].replace("/info.json","")+"/full/full/0/default."+o,crossOriginPolicy:"Anonymous",buildPyramid:!1}),t},getSizes:function(){return n.sizes},addImage:function(e,o,t){a&&(console.log("osViewer.addImage: url - "+e),console.log("osViewer.addImage: width - "+o),console.log("osViewer.addImage: height - "+t)),n.viewer?n.viewer.addTiledImage({tileSource:{type:"legacy-image-pyramid",levels:[{url:e,height:t,width:o}]},x:0,y:1.6,width:1}):a&&console.log("Viewer not initialized yet; cannot add image")},getImageInfo:function(){return n.viewer?n.viewer.tileSources:null},getScaleToOriginalSize:function(e){e||(e=0);var o=n.viewer.viewport._contentSize.x;return n.getImageInfo()[e].tileSource.width/o},scaleToOriginalSize:function(e,o){return a&&console.log("Overlays _scaleToOriginalSize: value - "+e),o||(o=0),e/n.viewer.viewport._contentSize.x*n.getImageInfo()[o].tileSource.width},scaleToImageSize:function(e,o){return a&&console.log("Overlays _scaleToImageSize: value - "+e),o||(o=0),e*n.viewer.viewport._contentSize.x/n.getImageInfo()[o].tileSource.width},close:function(){a&&console.log("Closing openSeadragon viewer"),n.viewer&&n.viewer.destroy()},redraw:function(){n.controls&&n.controls.setPanning(!0),o(n)},setImageSizes:function(e,o){if(o){o.replace(/[\{\}]/,"");var t=[];(o=JSON.parse(o)).forEach(function(e){t.push({width:parseInt(e),height:parseInt(e)})}),t.length>0?e.sizes=t:delete e.sizes}},setTileSizes:function(e,o){if(o){var t=configViewer.global.tileSizes.replace(/(\d+)/,'"$1"').replace("=",":"),o=JSON.parse(t),r=[];Object.keys(o).forEach(function(e){var t=o[e];r.push({width:parseInt(e),height:parseInt(e),scaleFactors:t})}),e.tiles=r}},onFirstTileLoaded:function(){var e=Q.defer();return viewImage.observables?viewImage.observables.firstTileLoaded.subscribe(function(o){e.resolve(o)},function(o){e.reject(o)}):e.reject("No observables defined"),e.promise},createTileSource:function(e){var o=Q.defer();return viewImage.tileSourceResolver.resolveAsJson(e).then(function(e){a&&console.log("IIIF image info ",e),viewImage.setImageSizes(e,s.global.imageSizes),viewImage.setTileSizes(e,s.global.tileSizes);return s.global.useTiles?new OpenSeadragon.IIIFTileSource(e):n.createPyramid(e)},function(e){if(viewImage.tileSourceResolver.isURI(s.image.tileSource)){a&&console.log("Image URL",s.image.tileSource);var o=new OpenSeadragon.ImageTileSource({url:s.image.tileSource,buildPyramid:!0,crossOriginPolicy:!1});return o}var t="Failed to load tilesource from "+o;return a&&console.log(t),Q.reject(t)}).then(function(e){o.resolve(e)}).catch(function(e){o.reject(e)}),o.promise}}}(jQuery,OpenSeadragon);String.prototype.startsWith||(String.prototype.startsWith=function(e){return 0===this.substring(0,e.length).localeCompare(e)}),String.prototype.endsWith||(String.prototype.endsWith=function(e){return 0===this.substring(this.length-e.length,this.length).localeCompare(e)}),Array.prototype.find||(Array.prototype.find=function(e){for(var o=0;o<this.length;o++){var t=this[o];if(e(t))return t}}),Number.isNaN||(Number.isNaN=function(e){return e!==e});var viewImage=function(e){"use strict";function o(e){return t(e.x)&&t(e.y)&&t(e.zoom)&&t(e.rotation)}function t(e){return"number"==typeof e&&!Number.isNaN(e)}return e.controls.persistence={init:function(t){if("undefined"!=typeof Storage){var r=null,i=e.getConfig().global.persistenceId;if(t.global.persistZoom||t.global.persistRotation){try{r=JSON.parse(localStorage.imageLocation)}catch(e){}r&&o(r)&&r.persistenceId===i&&(t.image.location={},t.global.persistZoom&&(t.image.location.zoom=r.zoom,t.image.location.x=r.x,t.image.location.y=r.y),t.global.persistRotation?t.image.location.rotation=r.rotation:t.image.location.rotation=0),window.onbeforeunload=function(){var o=e.controls.getLocation();o.persistenceId=e.getConfig().global.persistenceId,localStorage.imageLocation=JSON.stringify(o)}}}}},e}((viewImage=function(e){"use strict";function o(e,o){r&&(console.log("Viewer changed from "+e.osState+" event"),console.log("target location: ",e.targetLocation),console.log("Home zoom = ",o.viewer.viewport.getHomeZoom())),o.viewer.viewport.minZoomLevel=o.viewer.viewport.getHomeZoom()*o.getConfig().global.minZoomLevel;var t=e.targetLocation.zoom,i=new OpenSeadragon.Point(e.targetLocation.x,e.targetLocation.y);t*o.viewer.viewport.getHomeZoom()-o.viewer.viewport.minZoomLevel<.001||!t?(r&&console.log("Zooming home"),o.controls.goHome(!0)):(r&&(console.log("Zooming to "+t+" * "+o.controls.getCurrentRotationZooming()),console.log("panning to ",i)),o.viewer.viewport.zoomTo(t*o.controls.getCurrentRotationZooming(),null,!0),o.controls.setCenter(i)),"open"===e.osState&&0!==e.targetLocation.rotation&&o.controls.rotateTo(e.targetLocation.rotation)}var t,r=!1,i=!0,n=!1,a=null;return e.controls={init:function(t){r&&(console.log("##############################"),console.log("osViewer.controls.init"),console.log("##############################")),e.controls.persistence&&e.controls.persistence.init(t),r&&console.log("Setting viewer location to",t.image.location),e.observables&&(e.observables.redrawRequired.sample(e.observables.viewportUpdate).filter(function(o){return!!e.controls}).subscribe(function(t){o(t,e),e.controls.setPanning(!1)}),e.observables.viewerZoom.subscribe(function(o){r&&console.log("zoom to "+e.viewer.viewport.getZoom(!0)),e.controls.isPanning()||e.viewer.viewport.getZoom()<=e.viewer.viewport.minZoomLevel&&(r&&console.log("Zoomed out: Panning home"),e.controls.setPanning(!0),e.controls.goHome(!0),e.controls.setPanning(!1))})),$("#fullscreenTemplate").length>0&&$("#fullscreenTemplate").on("mousemove",function(){e.controls.fullscreenControlsFadeout()})},getLocation:function(){return{x:e.controls.getCenter().x,y:e.controls.getCenter().y,zoom:e.controls.getZoom()/e.controls.getCurrentRotationZooming(),rotation:e.controls.getRotation()}},getCenter:function(){return r&&console.log("image center is "+e.viewer.viewport.getCenter(!0)),e.viewer.viewport.getCenter(!0)},setCenter:function(o){r&&(console.log("Setting image center to "),console.log(o)),e.viewer.viewport.panTo(o,!0)},getZoom:function(){return r&&console.log("osViewer.controls.getZoom"),e.viewer.viewport.getZoom(!0)},zoomTo:function(o){r&&console.log("osViewer.controls.myZoomTo: zoomTo - "+o);var t=parseFloat(o)/e.viewer.viewport.getZoom();r&&console.log("osViewer.controls.myZoomTo: zoomBy - "+t),e.viewer.viewport.zoomBy(t,e.viewer.viewport.getCenter(!1),!0)},setFullScreen:function(o){r&&console.log("osViewer.controls.setFullScreen: enable - "+o),e.viewer.setFullScreen(o)},goHome:function(o){r&&console.log("osViewer.controls.panHome - zoom : "+e.viewer.viewport.getHomeZoom()),e.viewer.viewport.goHome(o),i=!0},reset:function(o){r&&console.log("osViewer.controls.goHome: bool - "+o),e.controls.goHome(!0),e.viewer.viewport.zoomTo(e.viewer.viewport.getHomeZoom(),null,!0),o&&e.controls.rotateTo(0)},zoomIn:function(){r&&console.log("osViewer.controls.zoomIn: zoomSpeed - "+e.getConfig().global.zoomSpeed),e.viewer.viewport.zoomBy(e.getConfig().global.zoomSpeed,e.viewer.viewport.getCenter(!1),!1)},zoomOut:function(){r&&console.log("osViewer.controls.zoomOut: zoomSpeed - "+e.getConfig().global.zoomSpeed),e.viewer.viewport.zoomBy(1/e.getConfig().global.zoomSpeed,e.viewer.viewport.getCenter(!1),!1)},getHomeZoom:function(o){o&&e.getCanvasSize().x/e.getCanvasSize().y<=e.getImageSize().x/e.getImageSize().y&&(e.viewer.viewport.homeFillsViewer=!0);var t=e.viewer.viewport.getHomeZoom();return e.viewer.viewport.homeFillsViewer=!1,t},rotateRight:function(){r&&console.log("osViewer.controls.rotateRight");var o=e.viewer.viewport.getRotation()+90;e.controls.rotateTo(o)},rotateLeft:function(){r&&console.log("osViewer.controls.rotateLeft");var o=e.viewer.viewport.getRotation()-90;e.controls.rotateTo(o)},getRotation:function(){return r&&console.log("osViewer.controls.getRotation"),e.viewer.viewport.getRotation()},setRotation:function(o){return r&&console.log("osViewer.controls.setRotation: rotation - "+o),e.controls.rotateTo(o)},rotateTo:function(o){o<0&&(o+=360),o%=360,r&&console.log("osViewer.controls.rotateTo: newRotation - "+o),n=!0,t=null,e.viewer.viewport.setRotation(o),n=!1},getCurrentRotationZooming:function(){var o=e.getSizes();return o&&o.rotated()?1/o.ratio(o.originalImageSize):1},setPanning:function(e){n=e},isPanning:function(){return n},fullscreenControlsFadeout:function(){r&&console.log("---------- osViewer.controls.fullscreenControlsFadeout() ----------"),a&&(clearTimeout(a),this.showFullscreenControls()),a=setTimeout(this.hideFullscreenControls,3e3)},hideFullscreenControls:function(){r&&console.log("---------- osViewer.controls.hideFullscreenControls() ----------"),$("#fullscreenRotateControlsWrapper, #fullscreenZoomSliderWrapper, #fullscreenExitWrapper, #fullscreenPrevWrapper, #fullscreenNextWrapper").stop().fadeOut("slow")},showFullscreenControls:function(){r&&console.log("---------- osViewer.controls.showFullscreenControls() ----------"),$("#fullscreenRotateControlsWrapper, #fullscreenZoomSliderWrapper, #fullscreenExitWrapper, #fullscreenPrevWrapper, #fullscreenNextWrapper").show()}},e}(viewImage||{},jQuery))||{},jQuery),viewImage=function(e){"use strict";function o(o){if(l)return f=e.viewer.viewport.viewerElementToViewportCoordinates(o.position),o.preventDefaultAction=!1,!0}function t(o){if(s){var t=e.viewer.viewport.viewerElementToViewportCoordinates(o.position),r=new OpenSeadragon.Rect(f.x,f.y,t.x-f.x,t.y-f.y);return t.x<f.x&&(r.x=t.x,r.width=f.x-t.x),t.y<f.y&&(r.y=t.y,r.height=f.y-t.y),e.viewer.updateOverlay(h,r,0),o.preventDefaultAction=!0,!0}if(l&&f){var i=e.overlays.getDrawingOverlay();if(i&&e.transformRect&&e.transformRect.isActive()&&e.overlays.contains(i.rect,f,d))f=null,n&&console.log("Action overlaps active overlay");else{s=!0,i&&m&&e.overlays.removeOverlay(i),h=document.createElement("div"),c&&$(h).addClass(c.styleClass),$(h).addClass(a);r=new OpenSeadragon.Rect(f.x,f.y,0,0);e.viewer.addOverlay(h,r,1)}return o.preventDefaultAction=!0,!0}}function r(o){if(s){s=!1;var t=e.viewer.viewport.viewerElementToViewportCoordinates(o.position),r=new OpenSeadragon.Rect(f.x,f.y,t.x-f.x,t.y-f.y);t.x<f.x&&(r.x=t.x,r.width=f.x-t.x),t.y<f.y&&(r.y=t.y,r.height=f.y-t.y),r.hitBox={l:r.x-v,t:r.y-v,r:r.x+r.width+v,b:r.y+r.height+v};var i={type:e.overlays.overlayTypes.RECTANGLE,element:h,rect:r,group:c.name};return e.overlays.setDrawingOverlay(i),g&&g(i),o.preventDefaultAction=!0,!0}}function i(e){if(l)return e.preventDefaultAction=!0,!0}var n=!1,a="drawing",l=!1,s=!1,c=null,g=null,u=null,v=5,d=.01,m=!0,h=null,f=null;return e.drawRect={init:function(){n&&(console.log("##############################"),console.log("osViewer.drawRect.init"),console.log("##############################")),u=e.viewer.addViewerInputHook({hooks:[{tracker:"viewer",handler:"clickHandler",hookHandler:i},{tracker:"viewer",handler:"dragHandler",hookHandler:t},{tracker:"viewer",handler:"pressHandler",hookHandler:o},{tracker:"viewer",handler:"dragEndHandler",hookHandler:r}]})},startDrawing:function(e,o){l=!0,c=e,g=o},endDrawing:function(o){l=!1,c=null,g=null,h&&o?e.viewer.removeOverlay(h):$(h).removeClass(a)},isActive:function(){return l},isDrawing:function(){return s},removeLastDrawnElement:function(){h&&e.viewer.removeOverlay(h)}},e}((viewImage=function(e){"use strict";function o(o){if(n){c&&s&&e.viewer.removeOverlay(c),(c=document.createElement("div")).style.border="2px solid green",g=e.viewer.viewport.viewerElementToViewportCoordinates(o.position),g=e.overlays.getRotated(g);var t=new OpenSeadragon.Rect(g.x,g.y,0,0);return e.viewer.addOverlay(c,t,1),o.preventDefaultAction=!0,!0}}function t(o){if(n){var t=e.viewer.viewport.viewerElementToViewportCoordinates(o.position);t=e.overlays.getRotated(t);var r=new OpenSeadragon.Rect(g.x,g.y,t.x-g.x,t.y-g.y);return t.x<g.x&&(r.x=t.x,r.width=g.x-t.x),t.y<g.y&&(r.y=t.y,r.height=g.y-t.y),e.viewer.updateOverlay(c,r,0),o.preventDefaultAction=!0,!0}}function r(o){if(n){var t=e.viewer.viewport.viewerElementToViewportCoordinates(o.position);t=e.overlays.getRotated(t);var r=new OpenSeadragon.Rect(g.x,g.y,t.x-g.x,t.y-g.y);return t.x<g.x&&(r.x=t.x,r.width=g.x-t.x),t.y<g.y&&(r.y=t.y,r.height=g.y-t.y),r.hitBox={l:r.x-l,t:r.y-l,r:r.x+r.width+l,b:r.y+r.height+l},o.preventDefaultAction=!0,!0}}function i(e){if(n)return e.preventDefaultAction=!0,!0}var n=!0,a=null,l=5,s=!0,c=null,g=null;return e.drawLine={init:function(){a=e.viewer.addViewerInputHook({hooks:[{tracker:"viewer",handler:"clickHandler",hookHandler:i},{tracker:"viewer",handler:"scrollHandler",hookHandler:i},{tracker:"viewer",handler:"dragHandler",hookHandler:t},{tracker:"viewer",handler:"pressHandler",hookHandler:o},{tracker:"viewer",handler:"dragEndHandler",hookHandler:r}]})},toggleDrawing:function(){n=!n}},e}(viewImage||{},jQuery))||{},jQuery),viewImage=function(e){"use strict";function o(o,t,r,n,a,s,c){g&&(console.log("------------------------------"),console.log("Overlays _createLine: x1 - "+o),console.log("Overlays _createLine: y1 - "+t),console.log("Overlays _createLine: x2 - "+r),console.log("Overlays _createLine: y2 - "+n),console.log("Overlays _createLine: title - "+a),console.log("Overlays _createLine: id - "+s),console.log("Overlays _createLine: group - "+c),console.log("------------------------------")),o=e.scaleToImageSize(o),t=e.scaleToImageSize(t),r=e.scaleToImageSize(r),n=e.scaleToImageSize(n);var u=new OpenSeadragon.Point(o,t),v=new OpenSeadragon.Point(r,n),d=u.distanceTo(v),m=l(u,v),h=(180-m)/2;console.log("drawing line with length = "+d+" and angle = "+m),t+=d/2*Math.sin(m*Math.PI/180),o-=d/2*Math.sin(m*Math.PI/180)/Math.tan(h*Math.PI/180);var p=e.viewer.viewport.imageToViewportRectangle(o,t,d,1),y=e.viewer.viewport.imageToViewportCoordinates(u),S=e.viewer.viewport.imageToViewportCoordinates(v),b={type:e.overlays.overlayTypes.LINE,rect:p,angle:m,point1:y,point2:S,group:c,id:s,title:a};w.getOverlayGroup(b.group).hidden||i(b),f.push(b)}function t(o,t,r,n,a,l,s){g&&(console.log("------------------------------"),console.log("Overlays _createRectangle: x - "+o),console.log("Overlays _createRectangle: y - "+t),console.log("Overlays _createRectangle: width - "+r),console.log("Overlays _createRectangle: height - "+n),console.log("Overlays _createRectangle: title - "+a),console.log("Overlays _createRectangle: id - "+l),console.log("Overlays _createRectangle: group - "+s),console.log("------------------------------")),o=e.scaleToImageSize(o),t=e.scaleToImageSize(t),r=e.scaleToImageSize(r),n=e.scaleToImageSize(n);var c=e.viewer.viewport.imageToViewportRectangle(o,t,r,n),u={type:e.overlays.overlayTypes.RECTANGLE,rect:c,group:s,id:l,title:a};w.getOverlayGroup(u.group).hidden||i(u),f.push(u)}function r(o){e.viewer.removeOverlay(o.element),o.element=null}function i(o){g&&(console.log("viewImage.overlays._drawOverlay"),console.log("overlay: ",o));var t=document.createElement("div");$(t).attr("id","overlay_"+o.id);var r=w.getOverlayGroup(o.group);r&&(g&&console.log("overlay style",r),$(t).addClass(r.styleClass),o.type===e.overlays.overlayTypes.LINE&&a(o.angle,t),r.interactive&&(t.focus=function(e){e?($(t).addClass(u),n(t,o)):(console.log(o.title," lose focus"),$(t).removeClass(u),$(".tooltipp#tooltip_"+o.id).remove()),d&&d(o,e)},t.highlight=function(e){e?$(t).addClass(v):$(t).removeClass(v)},$(t).on("mouseover",function(){g&&console.log("Overlays _drawOverlay: mouse over - "+r.name),e.overlays.focusBox(o.group,o.id)}),$(t).on("mouseout",function(){g&&console.log("Overlays _drawOverlay: mouse out - "+r.name),t.focus(!1)}),$(t).on("click",function(){m&&m(o)})),o.element=t,e.viewer.addOverlay(t,o.rect,0))}function n(e,o){if(o.title){var t=$(e).offset().top,r=$(e).offset().left,i=t+$(e).outerHeight(),n=r+$(e).outerWidth();console.log("tooltip coords = ",r,t,n,i);var a=$("<div class='tooltipp'>"+o.title+"</div>");$("body").append(a);var l=parseFloat(a.css("padding-top"));console.log("padding = ",l),a.css("max-width",n-r),a.css("top",t-a.outerHeight()-l),a.css("left",r),a.attr("id","tooltip_"+o.id)}}function a(e,o){if(g&&(console.log("Overlays _rotate: angle - "+e),console.log("Overlays _rotate: mapElement - "+o)),0!==e){$(o).css("-moz-transform","rotate("+e+"deg)"),$(o).css("-webkit-transform","rotate("+e+"deg)"),$(o).css("-ms-transform","rotate("+e+"deg)"),$(o).css("-o-transform","rotate("+e+"deg)"),$(o).css("transform","rotate("+e+"deg)");var t=Math.sin(e),r=Math.cos(e);$(o).css("filter","progid:DXImageTransform.Microsoft.Matrix(M11="+r+", M12="+t+", M21=-"+t+", M22="+r+", sizingMethod='auto expand'")}}function l(e,o){g&&(console.log("Overlays _calculateAngle: p1 - "+e),console.log("Overlays _calculateAngle: p2 - "+o));var t=o.x-e.x,r=o.y-e.y;return t>0?180*Math.atan(r/t)/Math.PI:t<0?180*Math.atan(r/t)/Math.PI+180:r<0?270:90}function s(e,o,t){return o.x>e.x-t&&o.x<e.x+e.width+t&&o.y>e.y-t&&o.y<e.y+e.height+t}function c(o){var t=o.position,r=viewerJS.helper.detectIEVersion();r&&10===r&&(t.x+=$(window).scrollLeft(),t.y+=$(window).scrollTop());var i=e.viewer.viewport.viewerElementToViewportCoordinates(t);f.forEach(function(o){s(o.rect,i,0)?e.overlays.showOverlay(o):e.overlays.hideOverlay(o)})}var g=!1,u="focus",v="highlight",d=null,m=null,h=null,f=[],w={},p=null;return e.overlays={init:function(o){g&&(console.log("##############################"),console.log("osViewer.overlays.init"),console.log("##############################")),$.extend(!0,w,o),e.observables.overlayRemove.subscribe(function(e){e.element&&$(e.element).remove()}),w.image.highlightCoords&&e.observables.viewerOpen.subscribe(function(o){for(var t=0;t<w.image.highlightCoords.length;t++){var r=w.image.highlightCoords[t];e.overlays.draw(r.name,r.displayTooltip)}p&&p()})},onInitialized:function(e){var o=p;p=function(){o&&o(),e()}},onFocus:function(e){var o=d;d=function(t,r){o&&o(t,r),e(t,r)}},onClick:function(e){var o=m;m=function(t){o&&o(t),e(t)}},getOverlays:function(){return f.slice()},getRects:function(){return f.filter(function(o){return o.type===e.overlays.overlayTypes.RECTANGLE}).slice()},getLines:function(){return f.filter(function(o){return o.type===e.overlays.overlayTypes.LINE}).slice()},draw:function(e,o){g&&(console.log("osViewer.overlays.draw: group - "+e),console.log("osViewer.overlays.draw: displayTitle - "+o));var r=w.getCoordinates(e);if(r)for(var i=0;i<r.coordinates.length;i++){var n=r.coordinates[i],a=o&&n.length>4?n[4]:"",l=n.length>5?n[5]:i;t(n[0],n[1],n[2]-n[0],n[3]-n[1],a,l,e)}},unDraw:function(o){g&&console.log("osViewer.overlays.unDraw: group - "+o);f=f.filter(function(t){return t.group!==o||(e.viewer.removeOverlay(t.element),!1)})},highlight:function(e){g&&console.log("osViewer.overlays.highlight: group - "+e),f.filter(function(o){return o.group===e}).forEach(function(e){e.element&&e.element.highlight(!0)})},unHighlight:function(e){g&&console.log("osViewer.overlays.unHighlight: group - "+e),f.filter(function(o){return o.group===e}).forEach(function(e){e.element&&e.element.highlight(!1)})},focusBox:function(e,o){g&&(console.log("osViewer.overlays.highlightBox: group - "+e),console.log("osViewer.overlays.highlightBox: id - "+o)),f.filter(function(o){return o.group===e}).forEach(function(e){e.element&&e.element.focus(e.id===o)})},addOverlay:function(o){g&&console.log("osViewer.overlays.addOverlay: overlay - "+o),f.push(o),o.element&&e.viewer.updateOverlay(o.element,o.rect,0)},removeOverlay:function(o){if(o){g&&console.log("Removing overlay "+o.id);var t=f.indexOf(o);f.splice(t,1),o.element&&e.viewer.removeOverlay(o.element)}},drawRect:function(e,o,r,i){g&&(console.log("osViewer.overlays.drawRect: rectangle - "+e),console.log("osViewer.overlays.drawRect: group - "+o)),t(e.x,e.y,e.width,e.height,r||"",i||"",o)},drawLine:function(e,t,r){g&&(console.log("osViewer.overlays.drawLine: point1 - "+e),console.log("osViewer.overlays.drawLine: point2 - "+t),console.log("osViewer.overlays.drawLine: group - "+r)),o(e.x,e.y,t.x,t.y,"","",r)},showOverlay:function(e){e&&!e.element&&(i(e),d&&d(e,!0))},hideOverlay:function(e){e&&e.element&&h!=e&&(r(e),d&&d(e,!1))},getOverlay:function(e,o){return f.find(function(t){return o?t.id===e&&t.group===o:t.id===e})},getCoordinates:function(o){if(g&&console.log("getCoordinates - overlay",o),o.type===e.overlays.overlayTypes.RECTANGLE){var t=e.viewer.viewport.viewportToImageRectangle(o.rect);return t=t.times(e.getScaleToOriginalSize())}if(o.type===e.overlays.overlayTypes.LINE)return{point1:e.viewer.viewport.viewportToImageCoordinates(o.poin1),point2:e.viewer.viewport.viewportToImageCoordinates(o.poin2)}},getDrawingOverlay:function(){return h},setDrawingOverlay:function(e){h=e},showHiddenOverlays:function(){e.viewer.addViewerInputHook({hooks:[{tracker:"viewer",handler:"moveHandler",hookHandler:c}]})},contains:function(e,o,t){return null==t&&(t=0),s(e,o,t)},overlayTypes:{RECTANGLE:"rectangle",LINE:"line"},getRotated:function(e){return e}},e}((viewImage=function(e){"use strict";return e.Measures=function(e){this.config=e.getConfig(),this.$container=$("#"+this.config.global.divId),this.outerCanvasSize=new OpenSeadragon.Point(this.$container.outerWidth(),this.$container.outerHeight()),this.innerCanvasSize=new OpenSeadragon.Point(this.$container.width(),this.$container.height()),this.originalImageSize=new OpenSeadragon.Point(this.getTotalImageWidth(e.getImageInfo()),this.getMaxImageHeight(e.getImageInfo())),this.footerHeight=this.config.global.footerHeight,this.rotation=null!=e.viewer?e.viewer.viewport.getRotation():0,this.xPadding=this.outerCanvasSize.x-this.innerCanvasSize.x,this.yPadding=this.outerCanvasSize.y-this.innerCanvasSize.y,this.innerCanvasSize.y-=this.footerHeight,this.fitToHeight()?this.imageDisplaySize=new OpenSeadragon.Point(this.innerCanvasSize.y/this.ratio(this.getRotatedSize(this.originalImageSize)),this.innerCanvasSize.y):this.imageDisplaySize=new OpenSeadragon.Point(this.innerCanvasSize.x,this.innerCanvasSize.x*this.ratio(this.getRotatedSize(this.originalImageSize))),this.rotated()&&(this.imageDisplaySize=this.getRotatedSize(this.imageDisplaySize))},e.Measures.prototype.getMaxImageWidth=function(e){var o=0;if(e&&e.length>0)for(var t=0;t<e.length;t++){var r=e[t];r.tileSource&&(correction=r.width,r=r.tileSource),o=Math.max(o,r.width*correction)}return o},e.Measures.prototype.getMaxImageHeight=function(e){var o=0;if(e&&e.length>0)for(var t=0;t<e.length;t++){var r=e[t],i=1;r.tileSource&&(i=r.width,r=r.tileSource),o=Math.max(o,r.height*i)}return o},e.Measures.prototype.getTotalImageWidth=function(e){var o=0;if(e&&e.length>0)for(var t=0;t<e.length;t++){var r=e[t],i=1;r.tileSource&&(i=r.width,r=r.tileSource),o+=r.width*i}return o},e.Measures.prototype.getTotalImageHeight=function(e){var o=0;if(e&&e.length>0)for(var t=0;t<e.length;t++){var r=e[t];r.tileSource&&(correction=r.width,r=r.tileSource),o+=r.height*correction}return o},e.Measures.prototype.getImageHomeSize=function(){var e=this.rotated()?1/this.ratio(this.originalImageSize):this.ratio(this.originalImageSize);if(this.fitToHeight())var o=(t=this.innerCanvasSize.y)/e;else var t=(o=this.innerCanvasSize.x)*e;return this.getRotatedSize(new OpenSeadragon.Point(o,t))},e.Measures.prototype.rotated=function(){return this.rotation%180!=0},e.Measures.prototype.landscape=function(){return this.ratio(this.originalImageSize)<1},e.Measures.prototype.ratio=function(e){return e.y/e.x},e.Measures.prototype.getRotatedSize=function(e){return new OpenSeadragon.Point(this.rotated()?e.y:e.x,this.rotated()?e.x:e.y)},e.Measures.prototype.fitToHeight=function(){return!this.config.global.adaptContainerHeight&&this.ratio(this.getRotatedSize(this.originalImageSize))>this.ratio(this.innerCanvasSize)},e.Measures.prototype.resizeCanvas=function(){this.config.global.adaptContainerHeight&&this.$container.height(this.getRotatedSize(this.imageDisplaySize).y+this.footerHeight),this.outerCanvasSize=new OpenSeadragon.Point(this.$container.outerWidth(),this.$container.outerHeight()),this.innerCanvasSize=new OpenSeadragon.Point(this.$container.width(),this.$container.height()-this.footerHeight)},e.Measures.prototype.calculateExcessHeight=function(){var e=this.getRotatedSize(this.getImageHomeSize());return this.config.global.adaptContainerHeight||this.fitToHeight()?0:.5*(this.innerCanvasSize.y-e.y)},e}(viewImage||{},jQuery))||{},jQuery),viewImage=function(e){"use strict";return e.tileSourceResolver={resolveAsJsonOrURI:function(e){var o=Q.defer();return this.isJson(e)?o.resolve(e):this.isStringifiedJson(e)?o.resolve(JSON.parse(e)):o.resolve(e),o.promise},resolveAsJson:function(e){var o=Q.defer();if(this.isURI(e)){if(this.isJsonURI(e))return this.loadJsonFromURL(e);o.reject("Url does not lead to a json object")}else if("string"==typeof e)try{var t=JSON.parse(e);o.resolve(t)}catch(e){o.reject("String does not contain valid json: "+e)}else"object"==typeof e?o.resolve(e):o.reject("Neither a url nor a json object");return o.promise},loadJsonFromURL:function(e){var o=Q.defer();return this.isJsonURI(e)?OpenSeadragon.makeAjaxRequest(e,function(e){try{o.resolve(JSON.parse(e.responseText))}catch(e){o.reject(e)}},function(e){o.reject(e)}):o.reject("Not a json uri: "+e),o.promise},loadIfJsonURL:function(o){return Q.promise(function(t,r){if(e.tileSourceResolver.isURI(o)){var i={url:decodeURI(o),type:"GET",dataType:"JSON",async:!0,crossDomain:!0,accepts:{application_json:"application/json",application_jsonLd:"application/ld+json",text_json:"text/json",text_jsonLd:"text/ld+json"}};Q($.ajax(i)).then(function(e){t(e)}).fail(function(e){r("Failed to retrieve json from "+o)}),setTimeout(function(){r("Timeout after 10s")},1e4)}else r("Not a uri: "+o)})},isJsonURI:function(e){if(this.isURI(e)){var o=e.replace(/\?.*/,"");return o.endsWith("/")&&(o=o.substring(0,o.length-1)),o.toLowerCase().endsWith(".json")}return!1},isURI:function(e){return!(!e||"string"!=typeof e||!(e.startsWith("http://")||e.startsWith("https://")||e.startsWith("file:/")))},isStringifiedJson:function(e){if(e&&"string"==typeof e)try{var o=JSON.parse(e);return this.isJson(o)}catch(e){return!1}return!1},isJson:function(e){return e&&"object"==typeof e}},e}((viewImage=function(e){"use strict";function o(){a&&(console.log("---------- _setViewportHeight() ----------"),console.log("_setViewportHeight: view = ",c.viewSelector),console.log("_setViewportHeight: image = ",c.imageSelector),console.log("_setViewportHeight: sidebar = ",c.sidebarSelector),console.log("_setViewportHeight: sidebarInner = ",c.sidebarInnerSelector),console.log("_setViewportHeight: sidebarTabs = ",c.sidebarTabsSelector));var e=$(window).outerHeight(),o=$(c.navSelector).outerHeight(),t=e-o;a&&(console.log("_setViewportHeight: viewportHeight = ",e),console.log("_setViewportHeight: navHeight = ",o),console.log("_setViewportHeight: newHeight = ",t)),$(c.viewSelector).css("height",t),$(c.imageSelector).css("height",t),$(c.sidebarSelector).css("height",t),$(c.sidebarInnerSelector).css("height",t)}function t(){a&&(console.log("---------- _setSidebarTabHeight() ----------"),console.log("_setSidebarTabHeight: sidebarTabs = ",c.sidebarTabsSelector));var e=$(window).outerHeight(),o=e-$(c.navSelector).outerHeight(),t=$(c.sidebarTabsSelector).position(),r=o-t.top-15,i=$(".nav-tabs").outerHeight();a&&(console.log("_setSidebarTabHeight: tabPos = ",t),console.log("_setSidebarTabHeight: tabHeight = ",r)),e>768&&($(c.sidebarTabsSelector).css("height",r),$(c.sidebarTabContentSelector).css("height",r-i),$(c.sidebarTocWrapperSelector).css("min-height",r-i))}function r(){a&&(console.log("---------- _setSidebarButtonPosition() ----------"),console.log("_setSidebarButtonPosition: view = ",c.viewSelector));var e=$(c.viewSelector).outerHeight()/2;a&&console.log("_setSidebarButtonPosition: viewHalfHeight = ",e),$(c.sidebarToggleButton).css("top",e)}function i(){return a&&(console.log("---------- _checkSidebarStatus() ----------"),console.log("_checkSidebarStatus: sidebarStatus = ",c.sidebarStatus)),"false"!==c.sidebarStatus||($('[data-toggle="sidebar"]').removeClass("in"),$(".reading-mode__content-sidebar").removeClass("in").prev().removeClass("in"),!1)}function n(){a&&console.log("---------- _showContent() ----------"),$(c.viewSelector).removeClass("invisible"),$(c.sidebarSelector).removeClass("invisible")}var a=!1,l=!0,s=null,c={navSelector:".reading-mode__navigation",viewSelector:"#contentView",imageContainerSelector:".reading-mode__content-view-image",imageSelector:"#readingModeImage",sidebarSelector:"#contentSidebar",sidebarToggleButton:".reading-mode__content-sidebar-toggle",sidebarInnerSelector:".reading-mode__content-sidebar-inner",sidebarTabsSelector:".reading-mode__content-sidebar-tabs",sidebarTabContentSelector:".tab-content",sidebarTocWrapperSelector:".widget-toc-elem-wrapp",sidebarStatus:"",useTabs:!0,useAccordeon:!1,msg:{}};return e.readingMode={init:function(e){if(a&&(console.log("##############################"),console.log("osViewer.readingMode.init"),console.log("##############################"),console.log("osViewer.readingMode.init: config - ",e)),$.extend(!0,c,e),!(l=viewerJS.helper.checkLocalStorage()))return!1;c.sidebarStatus=localStorage.getItem("sidebarStatus"),""!==c.sidebarStatus&&void 0!==c.sidebarStatus||localStorage.setItem("sidebarStatus","true"),o(),c.useTabs&&t(),r(),i(),setTimeout(function(){n()},500),c.useAccordeon&&(s=localStorage.getItem("activePanel"),$(".panel-collapse").each(function(){$(this).removeClass("in")}),null===s?(localStorage.setItem("activePanel","#collapseOne"),s=localStorage.getItem("activePanel"),$(s).addClass("in")):$(s).addClass("in"),$('a[data-toggle="collapse"]').on("click",function(){var e=$(this).attr("href");localStorage.setItem("activePanel",e)})),$('[data-toggle="sidebar"]').on("click",function(){$(this).toggleClass("in"),$(this).parents(".reading-mode__content-sidebar").toggleClass("in"),$(this).parents(".reading-mode__content-sidebar").prev().toggleClass("in"),c.sidebarStatus=localStorage.getItem("sidebarStatus"),"false"===c.sidebarStatus?localStorage.setItem("sidebarStatus","true"):localStorage.setItem("sidebarStatus","false")}),$(window).on("resize",function(){o(),c.useTabs&&t(),r()}),$(window).on("orientationchange",function(){o(),c.useTabs&&t(),r()}),"undefined"!=typeof jsf&&jsf.ajax.addOnEvent(function(e){switch(e.status){case"success":o(),c.useTabs&&t(),r()}})}},e}(viewImage||{},jQuery))||{},jQuery),viewImage=function(e){"use strict";var o={},t={global:{sliderDilation:12}};return e.zoomSlider={init:function(o){$.extend(!0,t,o),$(t.global.zoomSlider)&&(e.zoomSlider.addZoomSlider(t.global.zoomSlider),e.viewer.addHandler("zoom",function(o){e.zoomSlider.buttonToZoom(o.zoom)}))},buttonToMouse:function(r){var i=o.$button.width()/2,n=r-i;n<0&&(n=0),n+2*i>o.absoluteWidth&&(n=o.absoluteWidth-2*i),o.$button.css({left:n}),o.buttonPosition=n;var a=n/(o.absoluteWidth-2*i);a=1/t.global.sliderDilation*Math.tan(Math.atan(t.global.sliderDilation)*a);var l=e.viewer.viewport.getMinZoom()+(e.viewer.viewport.getMaxZoom()-e.viewer.viewport.getMinZoom())*a;e.controls.zoomTo(l)},buttonToZoom:function(r){if(o&&e.viewer.viewport){var i=(r-e.viewer.viewport.getMinZoom())/(e.viewer.viewport.getMaxZoom()-e.viewer.viewport.getMinZoom()),n=(i=1/Math.atan(t.global.sliderDilation)*Math.atan(t.global.sliderDilation*i))*(o.absoluteWidth-o.$button.width());Math.abs(e.viewer.viewport.getMaxZoom()-r)<1e-10&&(n=o.absoluteWidth-o.$button.width()),n<0&&(n=0),o.$button.css({left:n}),o.buttonPosition=n}},zoomSliderMouseUp:function(){o.mousedown=!1},zoomSliderMouseMove:function(t){if(o.mousedown){var r=$(this).offset(),i=t.pageX-r.left;e.zoomSlider.buttonToMouse(i)}},zoomSliderMouseDown:function(t){o.mousedown=!0;var r=$(this).offset(),i=t.pageX-r.left;e.zoomSlider.buttonToMouse(i)},buttonMouseDown:function(){return o.mousedown=!0,!1},addZoomSlider:function(r){o.$element=$(r),o.$button=o.$element.children(t.global.zoomSliderHandle),o.buttonPosition=0,o.absoluteWidth=o.$element.innerWidth(),o.mousedown=!1,o.$button.on("mousedown",e.zoomSlider.buttonMouseDown),o.$element.click(e.zoomSlider._zoomSliderClick),o.$element.mousedown(e.zoomSlider.zoomSliderMouseDown),o.$element.mousemove(e.zoomSlider.zoomSliderMouseMove),$(document).on("mouseup",e.zoomSlider.zoomSliderMouseUp)}},e}((viewImage=function(e){"use strict";function o(o){if(!w&&f){var t=e.viewer.viewport.viewerElementToViewportCoordinates(o.position);t=e.overlays.getRotated(t);var r=e.overlays.getDrawingOverlay().rect,i=(e.overlays.getDrawingOverlay().element,e.viewer.element),n=s(r,t,b);return n||(n=l(r,t,b)),!n&&e.overlays.contains(r,t,0)&&(n=e.transformRect.hitAreas.CENTER),n?$(i).css({cursor:e.transformRect.hitAreas.getCursor(n)}):$(i).css({cursor:m}),o.preventDefaultAction=!0,!0}}function t(o){if(f){if(!e.overlays.getDrawingOverlay())return!1;var t=e.overlays.getDrawingOverlay().rect,r=e.overlays.getDrawingOverlay().element,i=e.viewer.viewport.viewerElementToViewportCoordinates(o.position),n=s(t,i=e.overlays.getRotated(i),b);return n||(n=l(t,i,b)),!n&&e.overlays.contains(t,i,0)&&(n=e.transformRect.hitAreas.CENTER),h&&console.log("draw area = "+n),n&&($(r).tooltip("destroy"),O=i),T=n,o.preventDefaultAction=!0,!0}}function r(o){if(w){var t=e.viewer.viewport.viewerElementToViewportCoordinates(o.position);t=e.overlays.getRotated(t);var r,i,n=e.overlays.getDrawingOverlay().rect;if(T===e.transformRect.hitAreas.TOPLEFT)r=new OpenSeadragon.Point(Math.min(t.x,n.getBottomRight().x),Math.min(t.y,n.getBottomRight().y)),i=n.getBottomRight();else if(T===e.transformRect.hitAreas.TOPRIGHT)r=new OpenSeadragon.Point(n.getTopLeft().x,Math.min(t.y,n.getBottomRight().y)),i=new OpenSeadragon.Point(Math.max(t.x,n.getTopLeft().x),n.getBottomRight().y);else if(T===e.transformRect.hitAreas.BOTTOMLEFT)r=new OpenSeadragon.Point(Math.min(t.x,n.getBottomRight().x),n.getTopLeft().y),i=new OpenSeadragon.Point(n.getBottomRight().x,Math.max(t.y,n.getTopLeft().y));else if(T===e.transformRect.hitAreas.BOTTOMRIGHT)r=n.getTopLeft(),i=new OpenSeadragon.Point(Math.max(t.x,n.getTopLeft().x),Math.max(t.y,n.getTopLeft().y));else if(T===e.transformRect.hitAreas.LEFT)r=new OpenSeadragon.Point(Math.min(t.x,n.getBottomRight().x),n.getTopLeft().y),i=n.getBottomRight();else if(T===e.transformRect.hitAreas.RIGHT)r=n.getTopLeft(),i=new OpenSeadragon.Point(Math.max(t.x,n.getTopLeft().x),n.getBottomRight().y);else if(T===e.transformRect.hitAreas.TOP)r=new OpenSeadragon.Point(n.getTopLeft().x,Math.min(t.y,n.getBottomRight().y)),i=n.getBottomRight();else if(T===e.transformRect.hitAreas.BOTTOM)r=n.getTopLeft(),i=new OpenSeadragon.Point(n.getBottomRight().x,Math.max(t.y,n.getTopLeft().y));else if(T===e.transformRect.hitAreas.CENTER&&O){var a=O.x-t.x,l=O.y-t.y;n.x-=a,n.y-=l,O=t}return r&&i&&(n.x=r.x,n.y=r.y,n.width=i.x-r.x,n.height=i.y-r.y),e.viewer.updateOverlay(e.overlays.getDrawingOverlay().element,n,0),o.preventDefaultAction=!0,!0}if(T)return w=!0,o.preventDefaultAction=!0,!0}function i(o){if(f)return w&&y&&y(e.overlays.getDrawingOverlay()),w=!1,e.overlays.getDrawingOverlay()&&$(e.overlays.getDrawingOverlay().element).tooltip(),T="",O=null,o.preventDefaultAction=!0,!0}function n(e){if(w)return w=!1,e.preventDefaultAction=!0,!0}function a(e){if(w)return e.preventDefaultAction=!0,!0}function l(o,t,r){var i=d(t,o.getTopLeft(),o.getBottomLeft()),n=d(t,o.getBottomLeft(),o.getBottomRight()),a=d(t,o.getTopRight(),o.getBottomRight()),l=d(t,o.getTopLeft(),o.getTopRight()),s=Math.min(i,Math.min(a,Math.min(l,n)));if(s<=r){if(i===s)return e.transformRect.hitAreas.LEFT;if(a===s)return e.transformRect.hitAreas.RIGHT;if(l===s)return e.transformRect.hitAreas.TOP;if(n===s)return e.transformRect.hitAreas.BOTTOM}return""}function s(o,t,r){var i=u(t,o.getTopLeft()),n=u(t,o.getBottomLeft()),a=u(t,o.getTopRight()),l=u(t,o.getBottomRight()),s=Math.min(i,Math.min(a,Math.min(n,l)));if(s<=r){if(i===s)return e.transformRect.hitAreas.TOPLEFT;if(a===s)return e.transformRect.hitAreas.TOPRIGHT;if(n===s)return e.transformRect.hitAreas.BOTTOMLEFT;if(l===s)return e.transformRect.hitAreas.BOTTOMRIGHT}return""}function c(e){return e*e}function g(e,o){return c(e.x-o.x)+c(e.y-o.y)}function u(e,o){return Math.sqrt(g(e,o))}function v(e,o,t){var r=g(o,t);if(0==r)return g(e,o);var i=((e.x-o.x)*(t.x-o.x)+(e.y-o.y)*(t.y-o.y))/r;return i<0?g(e,o):i>1?g(e,t):g(e,{x:o.x+i*(t.x-o.x),y:o.y+i*(t.y-o.y)})}function d(e,o,t){return Math.sqrt(v(e,o,t))}var m="default",h=!1,f=!1,w=!1,p=null,y=null,S=null,b=.004,T="",O=null;return e.transformRect={init:function(){h&&(console.log("##############################"),console.log("osViewer.transformRect.init"),console.log("##############################")),S=e.viewer.addViewerInputHook({hooks:[{tracker:"viewer",handler:"clickHandler",hookHandler:a},{tracker:"viewer",handler:"dragHandler",hookHandler:r},{tracker:"viewer",handler:"pressHandler",hookHandler:t},{tracker:"viewer",handler:"dragEndHandler",hookHandler:n},{tracker:"viewer",handler:"releaseHandler",hookHandler:i},{tracker:"viewer",handler:"moveHandler",hookHandler:o}]})},startDrawing:function(o,t){h&&console.log("Start drawing"),e.overlays.setDrawingOverlay(o),f=!0,p=o.group,y=t,$(o.element).addClass("transforming")},endDrawing:function(){w=!1,p=null,y=null,f=!1;var o=e.overlays.getDrawingOverlay();null!=o&&($(o.element).removeClass("transforming"),$(o.element).css({cursor:m}))},isActive:function(){return f},hitAreas:{TOP:"t",BOTTOM:"b",RIGHT:"r",LEFT:"l",TOPLEFT:"tl",TOPRIGHT:"tr",BOTTOMLEFT:"bl",BOTTOMRIGHT:"br",CENTER:"c",isCorner:function(e){return e===this.TOPRIGHT||e===this.TOPLEFT||e===this.BOTTOMLEFT||e===this.BOTTOMRIGHT},isEdge:function(e){return e===this.TOP||e===this.BOTTOM||e===this.LEFT||e===this.RIGHT},getCursor:function(o){var t=e.viewer.viewport.getRotation()%180==90;return o===this.TOPLEFT||o===this.BOTTOMRIGHT?t?"nesw-resize":"nwse-resize":o===this.TOPRIGHT||o===this.BOTTOMLEFT?t?"nwse-resize":"nesw-resize":o===this.TOP||o===this.BOTTOM?t?"ew-resize":"ns-resize":o===this.RIGHT||o===this.LEFT?t?"ns-resize":"ew-resize":o===this.CENTER?"move":m}}},e}(viewImage||{},jQuery))||{},jQuery);